{include file="header.html"}
<div class="breadcrumbsContainer">
    <div class="container">
        <div class="breadcrubsRow">
            {$breadcrumbs}
        </div>
    </div>
</div>

<div class="catBackgroundGradient">
    <div class="bannerTop">
        <div class="container">
            <div class="backgroundImage" style="background-image: url(/files/{$row.pic_main});">
                <h2 class="heading">{if $row.h1}{$row.h1}{else}{$row.name}{/if}</h2>
                {if $row.excerpt}{$row.excerpt}{/if}
            </div>
        </div>
    </div>

    <div class="mobileCategories">
        <div class="container">
            <div class="headButtons">
				{if 0}
                <div class="topRow">
                    <span class="catTopBtn">{$row.name} <span class="icon"><img src="/images/arrow-down-gray.svg" alt=""></span></span>
                    <ul class="listCat">
						{section name=s loop=$subcategories}
							<li>
								<a href="{if $subcategories[s].url}{$subcategories[s].url}{else}{if $subcategories[s].htaccess_url}{$subcategories[s].htaccess_url}{else}/{#htaccess_categories#}/{$subcategories[s].id}{/if}{/if}">{$subcategories[s].name}</a>
							</li>
						{/section}
                    </ul>
                </div>
				{/if}
                <div class="downSection">
                    <div class="bottomRow">
                        <span class="leftSortBtn">СОРТИРАЙ <span class="icon"><img src="/images/arrow-down-gray.svg" alt=""></span></span>
                        <span class="filterBtn">ФИЛТРИ</span>
                    </div>
                    <div class="hiddenSections">
                        <div class="hiddenSort">
                            <a href="">Най нови</a>
                            <a href="">Най скъпи</a>
                            <a href="">Най яки</a>
                        </div>
                        <div class="filterWrapper">
                            <form id="hiddenFilter" type="post" action="/advanced-search">
                                <ul class="hiddenFiltersList">
                                    <li class="filterLi closeFilter"><span class="closeFilterBtn">Филтри</span> <span class="clearWholeForm" onclick="uncheckAllcheckboxes('#hiddenFilter')">изчисти</span></li>
									
									{section name=a loop=$attributes}
										{if $attributes[a].attribute_options}
											<li class="filterLi">
												<span class="filterLink hasSubFilter" href="">{$attributes[a].name|truncate:20}</span>
												<span class="selectedItems"></span>
												<div id="index{$smarty.section.a.index}" class="subFilterHolder">
													<ul class="subFilter">
														<li class="subfilterLi">
														{section name=ao loop=$attributes[a].attribute_options}
															<label>
																{$attributes[a].attribute_options[ao].option_text}
																<input type="checkbox" name="attribute_options[]" value="{$attributes[a].attribute_options[ao].id}" {$attributes[a].attribute_options[ao].selected} data-value="{$attributes[a].attribute_options[ao].option_text}">
																<span class="checkmark"></span>
															</label>
														{/section}
														</li>
													</ul>
												</div>
											</li>
										{/if}
									{/section}
									<li class="filterLi">
                                        <span class="filterLink hasSubFilter" href="">{#brands#}</span>
                                        <span class="selectedItems"></span>
                                        <div id="index2" class="subFilterHolder">
                                            <ul class="subFilter">
												{section name=bs loop=$brands_selected}
													<li class="subfilterLi">
														<label>
															{$brands_selected[bs].name}
															<input type="checkbox" name="brands[]" {$brands_selected[bs].selected} value="{$brands_selected[bs].id}" data-value="{$brands_selected[bs].name}">
															<span class="checkmark"></span>
														</label>
													</li>
												{/section}
                                            </ul>
                                        </div>
                                    </li>
                                    <li class="filterLi">
                                        <span class="filterLink hasSubFilter" href="">Цена</span>
                                        <span id="priceTextFilter" class="selectedItems"></span>
                                        <div id="index5" class="subFilterHolder">
                                            <ul class="subFilter">
                                                <li class="subfilterLi">
                                                </li>
                                            </ul>
                                            <div class="selector">
                                                <div class="price-slider">
                                                    <div id="slider-range2" class="ui-slider ui-corner-all ui-slider-horizontal ui-widget ui-widget-content">
                                                        <div class="ui-slider-range ui-corner-all ui-widget-header"></div>
                                                        <span tabindex="0" class="ui-slider-handle ui-corner-all ui-state-default"></span><span tabindex="0" class="ui-slider-handle ui-corner-all ui-state-default"></span>
                                                    </div>
                                                    <span id="min-price2" data-currency="лв." class="slider-price">0</span> 
                                                    <span id="max-price2" data-currency="лв." data-max="300"  class="slider-price">300</span>    
                                                </div> 
                                            </div>
                                        </div>
                                    </li>
                                </ul>
								{if 0}
								<span id="min-price-mobile" data-currency="лв." data-min="{$price_min}" class="slider-price">{$price_min}</span> 
                                <span id="max-price-mobile" data-currency="лв." data-max="{$price_max}"  class="slider-price">{$price_max}</span>    
								{/if}
								<input type="hidden" value="{$row.id}" name="category_id">
								<input type="hidden" value="process-advanced-search" name="param">
                                <button type="submit" id="mobileFilterSubmit">Покажи продукти</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="categoriesWrapper">
        <div class="container">
            <div class="filterContainer">
				{if $subcategories}
                <div class="subCategories">
                    <span class="heading">{$row.name}</span>
                    <ul class="listCat">
                       {section name=s loop=$subcategories}
							<li>
								<a href="{if $subcategories[s].url}{$subcategories[s].url}{else}{if $subcategories[s].htaccess_url}{$subcategories[s].htaccess_url}{else}/{#htaccess_categories#}/{$subcategories[s].id}{/if}{/if}">{$subcategories[s].name}</a>
							</li>
						{/section}
                    </ul>
                </div>
				{/if}
                <div class="formContainer">
                    <form id="formAdvancedSearch">
                        <span class="topTitle">Филтри</span>
                        <div class="formSection">
							{if $items}
								{section name=a loop=$attributes}
									{if $attributes[a].attribute_options}
										<span class="heading">{$attributes[a].name}</span>
										{section name=ao loop=$attributes[a].attribute_options}
											<label>
												{$attributes[a].attribute_options[ao].option_text}
												<input type="checkbox" name="attribute_options[]" value="{$attributes[a].attribute_options[ao].id}" {$attributes[a].attribute_options[ao].selected}>
												<span class="checkmark"></span>
											</label>
										{/section}
									{/if}
								{/section}
							{/if}
                            <span class="heading">{#brands#}</span>
							{section name=bs loop=$brands_selected}
                            <label>
                                {$brands_selected[bs].name}
                                <input type="checkbox" name="brands[]" {$brands_selected[bs].selected} value="{$brands_selected[bs].id}">
                                <span class="checkmark"></span>
                            </label>
							{/section}
                        </div>

                        <div class="selector">
                            <div class="price-slider">
                                <div id="slider-range" class="ui-slider ui-corner-all ui-slider-horizontal ui-widget ui-widget-content">
                                    <div class="ui-slider-range ui-corner-all ui-widget-header"></div>
                                    <span tabindex="0" class="ui-slider-handle ui-corner-all ui-state-default"></span><span tabindex="0" class="ui-slider-handle ui-corner-all ui-state-default"></span>
                                </div>
                                <span id="min-price" data-currency="лв." data-min="{$price_min}" class="slider-price">{$price_min}</span> 
                                <span id="max-price" data-currency="лв." data-max="{$price_max}"  class="slider-price">{$price_max}</span>    
                            </div> 
                        </div>
						<input type="hidden" value="{$row.id}" name="category_id">
						<input type="hidden" value="3" name="response_type">
						<script>
							function processAdvancedSearch(){
								var params = $("#formAdvancedSearch").serialize();
								$.ajax({
									type: "POST",
									url: "/",
									data: "param=process-advanced-search&"+params+"&price_min="+$("#min-price").text()+"&price_max="+$("#max-price").text(),
									dataType: "json",
									success: function(response){
										html_products = '';
										
										var products = response.products;
										
										for( var i = 0; i < products.length; i++){
											var product_url = '';
											html_products += '<div class="singleItem">';
											if ( products[i].htaccess_url ){
												product_url = products[i].htaccess_url;
											}else{
												product_url = '/{#htaccess_product#}/'+products[i].id;
											}
											
											var product_pic = '/images/noImage.png';
											if ( products[i].mainPic ){
												product_pic = '/files/tn/'+products[i].mainPic;
											}
											
											html_products += '<a class="product" href="'+product_url+'">';
											html_products += '<div class="imgContainer" style="background-image: url('+product_pic+');">';
											html_products += '<span class="likedBox"></span>';
											html_products += '</div>';
											html_products += '<h3 class="name">'+products[i].name+'</h3>';
											html_products += '<span class="excerpt">'+products[i].excerpt+'</span>';
											
											if ( products[i].price_specialoffer > 0.0 ){
												html_products += '<span class="d-flex flex-row justify-content-around">';
												html_products += '<span class="price">{if $abb_before_amount}{$currency_abb}{/if}' + products[i].price_specialoffer + ' {if !$abb_before_amount}{$currency_abb}{/if}</span>';
												html_products += '<del class="price-old">{if $abb_before_amount}{$currency_abb}{/if}' + products[i].price + ' {if !$abb_before_amount}{$currency_abb}{/if}</del>';
												html_products += '</span>';
											}else{
												html_products += '<span class="price">{if $abb_before_amount}{$currency_abb}{/if}' + products[i].price + ' {if !$abb_before_amount}{$currency_abb}{/if}</span>';
											}
											html_products += '</a>';
											html_products += '<div class="rating-wrap">';
											html_products += '<div class="starsRow" id="rating-' + products[i].id + '"></div>';
											html_products += '</div>';
											html_products += '</div>';
											
										}
										
										$("#holderProducts").empty();
										$("#holderProducts").append(html_products);
										
										for( var i = 0 ; i < products.length ; i++ ){
											$.fn.raty.defaults.path = '/js/raty/img';
											$('#rating-'+products[i].id).raty({
												readOnly:  true,
												starType:    'png', // Element used to represent a star.
												starHalf:    'star-half.png', // The name of the half star image.
												starOff:     'star-off.png',  // Name of the star image off.
												starOn:      'star-on.png',   // Name of the star image on.
												half:  true,
												start: products[i].rating
										   });
										}
										
										history.pushState(null, '', response.return_url);    
										
										$(".pagination").empty().append(response.generate_pages);
										
										
									}
								});
							}
							$(document).ready(function(){
								$("#formAdvancedSearch input").bind("click", function(){
									processAdvancedSearch();
								});
								$(".ui-slider").bind("click", function(){
									processAdvancedSearch();
								});
								$(".ui-slider-handle").bind("click", function(){
									processAdvancedSearch();
								});
							});
						</script>
                    </form>
                </div>
            </div>
            <div class="productsSection">
                <div class="topRow">
                    <div class="heading">Продукти <span class="subHeading">{if $resultsCount > 0}({$resultsCount}){/if}</span></div>
                    <div class="sortByContainer">
                        <span class="text">Сортиране по:</span>
                        <div class="sortByBox">
                            <select class="sortBy">
                                <option>Най нови</option>
                                <option>Най нови</option>
                                <option>Най скъпи</option>
                                <option>Най скъпи</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="productsRow" id="holderProducts">
                    {section name=i loop=$items}
                    <div class="singleItem">
                        <a class="product" href="{if $items[i].htaccess_url}{$items[i].htaccess_url}{else}/{#htaccess_product#}/{$items[i].id}{/if}">
                            <div class="imgContainer" style="background-image: url({if $items[i].mainPic}/files/tn/{$items[i].mainPic}{else}/images/noImage.png{/if});">
                                <span class="likedBox {if $items[i].in_favourites} likedBoxRed{/if}" name="{$items[i].id}"></span>
                            </div>
                            <h3 class="name">{$items[i].name}</h3>
                            <span class="excerpt">{$items[i].excerpt}</span>
                            {if $items[i].price_specialoffer > 0.0}
                                <span class="d-flex flex-row justify-content-around">
                                    <span class="price">{if $abb_before_amount}{$currency_abb}{/if}{$items[i].price_specialoffer|number_format: 2} {if !$abb_before_amount}{$currency_abb}{/if}</span>
                                    <del class="price-old">{if $abb_before_amount}{$currency_abb}{/if}{$items[i].price|number_format: 2} {if !$abb_before_amount}{$currency_abb}{/if}</del>
                                </span>
                            {elseif $items[i].price > 0.0}
                                <span class="price">{if $abb_before_amount}{$currency_abb}{/if}{$items[i].price|number_format: 2} {if !$abb_before_amount}{$currency_abb}{/if}</span>
                            {/if}
                        </a>
                        <!-- rating-wrap -->
                        <div class="rating-wrap">
                            <div class="starsRow" id="rating-{$items[i].id}"></div>
                            {*{if $items[i].reviews_count > 0 && $items[i].comments > 0}
                                {if $items[i].reviews_count > 0}<div class="label-rating"><small>{$items[i].reviews_count} {if $items[i].reviews_count > 1}{#reviews#}{else}{#review#}{/if}</small></div>{/if}
                                {if $items[i].comments > 0}<div class="label-rating"><small>{$items[i].comments} {if $items[i].comments > 1}{#comments#}{else}{#comment#}{/if}</small></div>{/if}
                            {else}
                                <div class="label-rating"><small>Все още няма ревюта.</small></div>
                            {/if}*}
                        </div> <!-- rating-wrap.// -->
                        <script>
                            $(document).ready(function () {
                                $.fn.raty.defaults.path = '/js/raty/img';
                                $('#rating-{$items[i].id}').raty({
                                    readOnly:  true,
                                    starType:    'png', // Element used to represent a star.
                                    starHalf:    'star-half.png', // The name of the half star image.
                                    starOff:     'star-off.png',  // Name of the star image off.
                                    starOn:      'star-on.png',   // Name of the star image on.
                                    half:  true,
                                    start: parseFloat({$items[i].rating})
                               });
                            });
                        </script>
                    </div>
                    {/section}
                </div>
                <script>
                    $("a.product").click(function(ev){
                        ev.preventDefault();
                        var link = $(this).prop("href");
                        var target = $(ev.target);
                        if (target.is(".likedBox")) {
                            console.log("likedBox clicked!")
                        }else{
                            console.log("Another area is clicked!")
                            window.location = link;
                        }
                    });
                </script>
                <div class="bottomRow">
                    <div class="excerpt">
                        {if $row.description && !$page}{$row.description}{/if}
                    </div>
                    <div class="pagination">
                        {$pages}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>

    function addCommas(nStr) {
        nStr += '';
        x = nStr.split('.');
        x1 = x[0];
        x2 = x.length > 1 ? '.' + x[1] : '';
        var rgx = /(\d+)(\d{3})/;
        while (rgx.test(x1)) {
            x1 = x1.replace(rgx, '$1' + ',' + '$2');
        }
        return x1 + x2;
    }


    $(document).ready(function () {

        $("#slider-range").slider({
            range: true,
            min: {$price_min},
            max: {$price_max},
            step: 1,
            slide: function (event, ui) {
                $("#min-price").html(addCommas(ui.values[ 0 ]));

                suffix = '';
                if (ui.values[ 1 ] == $("#max-price").data('max')) {
                    suffix = ' +';
                }
                $("#max-price").html(addCommas(ui.values[ 1 ] + suffix));
            }
        });

        $("#slider-range2").slider({
            range: true,
            min: {$price_min},
            max: {$price_max},
            step: 1,
            slide: function (event, ui) {
                $("#min-price2").html(addCommas(ui.values[ 0 ]));

                suffix = '';
                if (ui.values[ 1 ] == $("#max-price2").data('max')) {
                    suffix = ' +';
                }
                $("#max-price2").html(addCommas(ui.values[ 1 ] + suffix));

                $("#priceTextFilter").html(addCommas(ui.values[ 0 ]) + "лв. - " + addCommas(ui.values[ 1 ] + suffix + " лв."));
                $("#priceTextFilter").parent().addClass("height70");
            }
        });

    });

</script>
{include file="footer.html"}